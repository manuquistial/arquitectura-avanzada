{
  "dashboard": {
    "title": "Carpeta Ciudadana - Cache Efficiency",
    "tags": ["carpeta-ciudadana", "cache", "redis"],
    "timezone": "browser",
    "schemaVersion": 27,
    "version": 1,
    "refresh": "30s",
    "panels": [
      {
        "id": 1,
        "title": "Cache Hit Rate",
        "type": "graph",
        "gridPos": {"x": 0, "y": 0, "w": 12, "h": 8},
        "targets": [
          {
            "expr": "sum(rate(cache_hits[5m])) / (sum(rate(cache_hits[5m])) + sum(rate(cache_misses[5m]))) * 100",
            "legendFormat": "Overall Hit Rate %",
            "refId": "A"
          },
          {
            "expr": "sum(rate(cache_hits[5m])) by (service_name) / (sum(rate(cache_hits[5m])) by (service_name) + sum(rate(cache_misses[5m])) by (service_name)) * 100",
            "legendFormat": "{{service_name}} Hit Rate %",
            "refId": "B"
          }
        ],
        "yaxes": [
          {
            "format": "percent",
            "label": "Hit Rate",
            "max": 100,
            "min": 0
          }
        ]
      },
      {
        "id": 2,
        "title": "Cache Operations (Hits vs Misses)",
        "type": "graph",
        "gridPos": {"x": 12, "y": 0, "w": 12, "h": 8},
        "targets": [
          {
            "expr": "sum(rate(cache_hits[1m])) by (service_name)",
            "legendFormat": "Hits - {{service_name}}",
            "refId": "A"
          },
          {
            "expr": "sum(rate(cache_misses[1m])) by (service_name)",
            "legendFormat": "Misses - {{service_name}}",
            "refId": "B"
          }
        ],
        "yaxes": [
          {
            "format": "ops",
            "label": "Operations/sec"
          }
        ]
      },
      {
        "id": 3,
        "title": "Redis Connection Pool",
        "type": "graph",
        "gridPos": {"x": 0, "y": 8, "w": 12, "h": 8},
        "targets": [
          {
            "expr": "redis_connection_pool_size",
            "legendFormat": "{{service_name}} - Pool Size",
            "refId": "A"
          },
          {
            "expr": "redis_connection_pool_in_use",
            "legendFormat": "{{service_name}} - In Use",
            "refId": "B"
          }
        ]
      },
      {
        "id": 4,
        "title": "Redis Command Latency",
        "type": "graph",
        "gridPos": {"x": 12, "y": 8, "w": 12, "h": 8},
        "targets": [
          {
            "expr": "histogram_quantile(0.95, sum(rate(redis_command_duration_bucket[5m])) by (le, command))",
            "legendFormat": "{{command}} - p95",
            "refId": "A"
          }
        ],
        "yaxes": [
          {
            "format": "s",
            "label": "Latency (seconds)"
          }
        ]
      },
      {
        "id": 5,
        "title": "Cache Keys by Type",
        "type": "piechart",
        "gridPos": {"x": 0, "y": 16, "w": 12, "h": 8},
        "targets": [
          {
            "expr": "sum(cache_keys_total) by (key_type)",
            "legendFormat": "{{key_type}}",
            "refId": "A"
          }
        ]
      },
      {
        "id": 6,
        "title": "Cache Evictions",
        "type": "graph",
        "gridPos": {"x": 12, "y": 16, "w": 12, "h": 8},
        "targets": [
          {
            "expr": "sum(rate(cache_evictions[5m]))",
            "legendFormat": "Evictions/sec",
            "refId": "A"
          }
        ]
      },
      {
        "id": 7,
        "title": "Distributed Lock Contention",
        "type": "graph",
        "gridPos": {"x": 0, "y": 24, "w": 12, "h": 8},
        "targets": [
          {
            "expr": "sum(rate(distributed_lock_wait_duration_sum[5m])) / sum(rate(distributed_lock_wait_duration_count[5m]))",
            "legendFormat": "Avg Wait Time",
            "refId": "A"
          }
        ],
        "yaxes": [
          {
            "format": "s",
            "label": "Wait Time (seconds)"
          }
        ]
      },
      {
        "id": 8,
        "title": "Idempotency Key Usage",
        "type": "graph",
        "gridPos": {"x": 12, "y": 24, "w": 12, "h": 8},
        "targets": [
          {
            "expr": "sum(rate(idempotency_key_reused[5m])) by (service_name)",
            "legendFormat": "{{service_name}} - Duplicate Requests",
            "refId": "A"
          }
        ]
      }
    ]
  }
}

